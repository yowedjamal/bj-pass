"use strict";
/**
 * bj-pass Authentication Widget
 * Widget d'authentification OAuth 2.0/OpenID Connect moderne et sécurisé
 * @version 1.0.0
 * @author yowedjamal
 * @license MIT
 */class e{constructor(e={}){this.environments={test:{baseUrl:"https://test-tx-pki.gouv.bj",defaultAuthServer:"main-as"},production:{baseUrl:"https://tx-pki.gouv.bj",defaultAuthServer:"main-as"}},this.defaultConfig={environment:"test",clientId:"",authServer:"",scope:"openid profile",redirectUri:"http://127.0.0.1:5500/examples/redirect.html",pkce:!0,verifyAccessToken:!1,tokenVerificationScopes:["urn:safelayer:eidas:oauth:token:introspect"],beUrl:"",beBearer:"",header:{},ui:{showEnvSelector:!0,container:"#bjpass-auth-container",language:"fr",primaryColor:"#0066cc",theme:"default"},backendUrl:"https://your-backend.com",backendEndpoints:{start:"/auth/start",status:"/auth/api/status",user:"/auth/api/user",logout:"/auth/api/logout",refresh:"/auth/api/refresh"},frontendOrigin:"https://your-frontend.com",backendOrigin:"https://your-backend.com",useBackend:!0,popupMode:!0,autoClosePopup:!0},this.config={...this.defaultConfig,...e},this.resolvedConfig=this.applyEnvironmentConfig()}applyEnvironmentConfig(){const e=this.config.environment||"test",t=this.environments[e]||this.environments.test;return{...this.config,baseUrl:t.baseUrl,authServer:this.config.authServer||t.defaultAuthServer}}updateConfig(e){this.config={...this.config,...e},this.resolvedConfig=this.applyEnvironmentConfig()}get(){return this.resolvedConfig}getEnvironments(){return Object.keys(this.environments)}}class t{static generateRandomString(e){const t=new Uint8Array(e);return window.crypto.getRandomValues(t),Array.from(t,e=>e.toString(16).padStart(2,"0")).join("")}static async generateCodeChallenge(e){const t=(new TextEncoder).encode(e),n=await window.crypto.subtle.digest("SHA-256",t);return btoa(String.fromCharCode(...new Uint8Array(n))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}static base64UrlToArrayBuffer(e){const t="=".repeat((4-e.length%4)%4),n=e.replace(/-/g,"+").replace(/_/g,"/")+t,r=atob(n),i=new Uint8Array(r.length);for(let e=0;e<r.length;++e)i[e]=r.charCodeAt(e);return i}static checkBrowserCompatibility(){return!(!window.crypto||!window.crypto.subtle)}}class n{static setItem(e,t){sessionStorage.setItem(`tx_auth_${e}`,t)}static getItem(e){return sessionStorage.getItem(`tx_auth_${e}`)}static removeItem(e){sessionStorage.removeItem(`tx_auth_${e}`)}static clear(){["state","code_verifier","nonce","success"].forEach(e=>this.removeItem(e))}static generateAndStoreAuthData(e){const n=t.generateRandomString(32),r=t.generateRandomString(32),i=t.generateRandomString(64);return this.setItem("state",n),this.setItem("code_verifier",i),e.includes("openid")&&this.setItem("nonce",r),{state:n,nonce:r,codeVerifier:i}}}class r{constructor(e){this.config=e}async buildAuthorizationUrl(e){const{state:n,nonce:r,codeVerifier:i}=e,s=await t.generateCodeChallenge(i),o=new URL(`${this.config.baseUrl}/trustedx-authserver/oauth`);this.config.authServer&&(o.pathname+=`/${encodeURIComponent(this.config.authServer)}`);const a=new URLSearchParams({response_type:"code",client_id:this.config.clientId,redirect_uri:this.config.redirectUri,scope:this.config.scope.split("+").join(" "),state:n,code_challenge:s,code_challenge_method:"S256",prompt:"login"});return this.config.scope.includes("openid")&&r&&a.set("nonce",r),o.search=a.toString(),o.toString()}buildTokenUrl(){return`${this.config.baseUrl}/trustedx-authserver/oauth/${encodeURIComponent(this.config.authServer)}/token`}buildJWKSUrl(){return`${this.config.baseUrl}/trustedx-authserver/oauth/keys`}buildIntrospectionUrl(){return`${this.config.baseUrl}/trustedx-authserver/oauth/token/verify`}}class i{constructor(e,t){this.config=e,this.urlBuilder=t}async validateIdToken(e){try{const[t,r]=e.split("."),i=JSON.parse(atob(t)),s=JSON.parse(atob(r)),o=Math.floor(Date.now()/1e3),a=n.getItem("nonce");if(s.exp<o)throw new Error("Token expired");if(s.nonce!==a)throw new Error("Invalid nonce");if(s.aud!==this.config.clientId)throw new Error("Invalid audience");const c=(await this.fetchJWKS()).keys.find(e=>e.kid===i.kid);if(!c)throw new Error("No matching public key found");if(!await this.verifySignature(e,c))throw new Error("Invalid signature");return s}catch(e){throw console.error("ID Token validation failed:",e),new Error("Invalid ID Token")}}async verifyAccessToken(e){try{const t=await fetch(this.urlBuilder.buildIntrospectionUrl(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Bearer ${e}`},body:new URLSearchParams({token:e})}),n=await t.json();if(!t.ok||!n.active)throw new Error("Token verification failed");return n}catch(e){throw console.error("Token verification error:",e),e}}async fetchJWKS(){const e=await fetch(this.urlBuilder.buildJWKSUrl());if(!e.ok)throw new Error("Failed to fetch JWKS");return await e.json()}async verifySignature(e,n){try{const r=await window.crypto.subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]),[i,s,o]=e.split("."),a=t.base64UrlToArrayBuffer(o),c=(new TextEncoder).encode(`${i}.${s}`);return await window.crypto.subtle.verify("RSASSA-PKCS1-v1_5",r,a,c)}catch(e){return console.error("Signature verification error:",e),!1}}}class s{constructor(e){this.container=e,this.element=null,this.eventListeners=new Map}createElement(e,t="",n=""){const r=document.createElement(e);return t&&(r.className=t),n&&(r.innerHTML=n),r}addEventListeners(e,t){Object.entries(t).forEach(([t,n])=>{e.addEventListener(t,n),this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push({event:t,handler:n})})}removeEventListeners(){this.eventListeners.forEach((e,t)=>{e.forEach(({event:e,handler:n})=>{t.removeEventListener(e,n)})}),this.eventListeners.clear()}destroy(){this.removeEventListeners(),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element)}render(){throw new Error("render() must be implemented by subclass")}show(){this.element&&(this.element.style.display="block")}hide(){this.element&&(this.element.style.display="none")}}class o extends s{constructor(e,t,n){super(e),this.config=t,this.onEnvironmentChange=n,this.render()}render(){if(!this.config.ui.showEnvSelector)return;const e=this.config.getEnvironments().map(e=>`\n        <label>\n          <input type="radio" name="env" value="${e}" ${e===this.config.get().environment?"checked":""}>\n          ${e.charAt(0).toUpperCase()+e.slice(1)}\n        </label>\n      `).join("");this.element=this.createElement("div","bjpass-env-selector",`\n      <div class="env-selector-label">Environment:</div>\n      ${e}\n    `);this.element.querySelectorAll('input[name="env"]').forEach(e=>{this.addEventListeners(e,{change:e=>this.onEnvironmentChange(e.target.value)})}),this.container.appendChild(this.element)}}class a extends s{constructor(e,t,n){super(e),this.config=t,this.onLogin=n,this.render()}render(){this.element=this.createElement("button","bjpass-login-btn","Se connecter"),this.element.type="button",this.element.style.cssText=`\n      width: 100%;\n      padding: 12px 24px;\n      background-color: ${this.config.ui.primaryColor};\n      color: white;\n      border: none;\n      border-radius: 6px;\n      font-size: 16px;\n      cursor: pointer;\n      transition: background-color 0.2s;\n    `,this.addEventListeners(this.element,{click:this.onLogin,mouseover:()=>{this.element.style.opacity="0.9"},mouseout:()=>{this.element.style.opacity="1"}}),this.container.appendChild(this.element)}setLoading(e){this.element.disabled=e,this.element.innerHTML=e?"Connexion...":"Se connecter"}}class c extends s{constructor(e){super(e),this.render()}render(){this.element=this.createElement("div","bjpass-loading",'\n      <div class="spinner"></div>\n      <div class="loading-text">Authentification en cours...</div>\n    '),this.element.style.cssText="\n      display: none;\n      text-align: center;\n      padding: 20px;\n    ";if(this.element.querySelector(".spinner").style.cssText="\n      border: 3px solid #f3f3f3;\n      border-radius: 50%;\n      border-top: 3px solid #0066cc;\n      width: 30px;\n      height: 30px;\n      animation: spin 1s linear infinite;\n      margin: 0 auto 10px;\n    ",!document.getElementById("bjpass-spinner-styles")){const e=document.createElement("style");e.id="bjpass-spinner-styles",e.textContent="\n        @keyframes spin {\n          0% { transform: rotate(0deg); }\n          100% { transform: rotate(360deg); }\n        }\n      ",document.head.appendChild(e)}this.container.appendChild(this.element)}}class h extends s{constructor(e,t){super(e),this.config=t,this.render()}render(){this.element=this.createElement("div","bjpass-error"),this.element.style.cssText="\n      display: none;\n      padding: 12px;\n      margin: 10px 0;\n      background-color: #fee;\n      border: 1px solid #fcc;\n      border-radius: 4px;\n      color: #c33;\n      font-size: 14px;\n    ",this.container.appendChild(this.element)}showError(e){this.element.textContent=e,this.show()}clearError(){this.element.textContent="",this.hide()}}class d{constructor(e){this.config=e,this.container=null,this.components={},this.state={isLoading:!1,error:null}}initialize(){if(this.container=document.querySelector(this.config.ui.container),!this.container)throw new Error(`Container ${this.config.ui.container} not found`);this.createMainContainer(),this.initializeComponents()}createMainContainer(){this.mainElement=document.createElement("div"),this.mainElement.className="bjpass-widget",this.mainElement.style.cssText="\n      max-width: 400px;\n      margin: 0 auto;\n      padding: 20px;\n      border: 1px solid #ddd;\n      border-radius: 8px;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    ";const e=document.createElement("h3");e.textContent="Authentification BjPass",e.style.cssText=`\n      color: ${this.config.ui.primaryColor};\n      text-align: center;\n      margin: 0 0 20px 0;\n    `,this.mainElement.appendChild(e),this.container.appendChild(this.mainElement)}initializeComponents(){this.components.envSelector=new o(this.mainElement,this.config,this.onEnvironmentChange.bind(this)),this.components.loginButton=new a(this.mainElement,this.config,this.onLoginClick.bind(this)),this.components.loadingSpinner=new c(this.mainElement),this.components.errorDisplay=new h(this.mainElement,this.config);const e=document.createElement("p");e.textContent="Vous serez redirigé vers le service d'authentification sécurisée",e.style.cssText="\n      text-align: center;\n      margin: 15px 0 0 0;\n      font-size: 0.9em;\n      color: #666;\n    ",this.mainElement.appendChild(e)}onEnvironmentChange(e){this.onEnvironmentChangeCallback&&this.onEnvironmentChangeCallback(e)}onLoginClick(){this.onLoginCallback&&this.onLoginCallback()}setState(e){this.state={...this.state,...e},this.updateUI()}updateUI(){this.state.isLoading?(this.components.loginButton.setLoading(!0),this.components.loadingSpinner.show(),this.components.errorDisplay.clearError()):(this.components.loginButton.setLoading(!1),this.components.loadingSpinner.hide(),this.state.error?this.components.errorDisplay.showError(this.state.error):this.components.errorDisplay.clearError())}destroy(){Object.values(this.components).forEach(e=>{e.destroy&&e.destroy()}),this.mainElement&&this.mainElement.parentNode&&this.mainElement.parentNode.removeChild(this.mainElement)}setOnEnvironmentChange(e){this.onEnvironmentChangeCallback=e}setOnLogin(e){this.onLoginCallback=e}}class l{constructor(e){this.config=e}async exchangeCode(e,t){const r=await fetch(this.config.beUrl,{method:"POST",headers:{"Content-Type":"application/json",...this.config.header},body:JSON.stringify({code:e,state:t,redirect_uri:this.config.redirectUri,code_verifier:n.getItem("code_verifier")})});if(!r.ok){const e=await r.json();throw new Error(e.message||"Échec de l'authentification")}return await r.json()}async exchangeCodeDirect(e,t,r){const i=n.getItem("code_verifier");if(!i)throw new Error("Missing code verifier");const s=await fetch(r.buildTokenUrl(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:e,redirect_uri:this.config.redirectUri,client_id:this.config.clientId,code_verifier:i})}),o=await s.json();if(!s.ok)throw new Error(o.error_description||"Failed to obtain token");return o}async handleBackendAuthResponse(e){try{"success"===e.status?await this.handleBackendAuthSuccess(e):this.handleBackendAuthError(e)}catch(e){this.handleError("callback_error",e.message)}}async handleBackendAuthSuccess(e){try{n.setItem("user",JSON.stringify(e.user)),n.setItem("success","true"),this.popupManager.close(),this.uiManager.setState({isLoading:!1,error:null});const t=this.configManager.get();t.onSuccess&&t.onSuccess({user:e.user,backendData:e,source:"backend"}),await this.verifyBackendStatus()}catch(e){this.handleError("success_verification_error",e.message)}}handleBackendAuthError(e){this.popupManager.close(),this.handleError(e.error||"backend_error",e.message||"Erreur d'authentification");const t=this.configManager.get();t.onError&&t.onError({error:e.error,error_description:e.message,source:"backend"})}async verifyBackendStatus(){try{const e=this.configManager.get(),t=new URL(e.backendEndpoints.status,e.backendUrl),r=await fetch(t.toString(),{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!r.ok)throw new Error(`Status check failed: ${r.status}`);const i=await r.json();if(!i.authenticated)throw n.clear(),new Error("User not authenticated on backend");n.setItem("user",JSON.stringify(i.user)),n.setItem("authenticated","true"),console.log("Backend status verified:",i)}catch(e){throw console.error("Backend status verification failed:",e),e}}async startBackendAuthFlow(){const e=this.configManager.get();if(!e.backendUrl)throw new Error("Backend URL not configured");const t=new URL(e.backendEndpoints.start,e.backendUrl);e.returnUrl&&t.searchParams.set("return_url",e.returnUrl),this.popupManager.open(t.toString(),()=>{this.uiManager.setState({isLoading:!1}),n.getItem("success")||this.handleError("popup_closed","La fenêtre d'authentification a été fermée")})}async getUserInfoFromBackend(){const e=this.configManager.get(),t=new URL(e.backendEndpoints.user,e.backendUrl),n=await fetch(t.toString(),{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!n.ok)throw new Error(`User info request failed: ${n.status}`);return(await n.json()).user}async logoutFromBackend(){const e=this.configManager.get(),t=new URL(e.backendEndpoints.logout,e.backendUrl),n=await fetch(t.toString(),{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!n.ok)throw new Error(`Backend logout failed: ${n.status}`);console.log("Backend logout successful")}}class u{constructor(){this.popup=null,this.checkInterval=null}open(e,t){const n=(screen.width-500)/2,r=(screen.height-600)/2;this.popup=window.open(e,"BjPassAuth",`width=500,height=600,top=${r},left=${n},resizable=yes,scrollbars=yes`),this.checkInterval=setInterval(()=>{this.popup&&this.popup.closed&&(this.close(),t&&t())},500)}close(){this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null),this.popup&&!this.popup.closed&&this.popup.close(),this.popup=null}isOpen(){return this.popup&&!this.popup.closed}}class g{static getErrorMessage(e,t){let n="Erreur d'authentification";const r={invalid_token:"Token invalide ou expiré",unsuported_grant_type_error:"Type de subvention OAuth invalide",insufficient_scope:"Permissions insuffisantes",invalid_grant:"Code d'autorisation invalide ou expiré",access_denied:"Authentification annulée",invalid_request:"Requête invalide",invalid_scope:"Permissions invalides",server_error:"Erreur du serveur",popup_closed:"La fenêtre d'authentification a été fermée",browser_error:"Navigateur non supporté",backend_error:"Erreur du backend",token_error:"Erreur de validation du token",token_exchange_error:"Erreur lors de l'échange"};return r[e]&&(n=r[e]),t&&(n+=`: ${t}`),n}}class p{constructor(n={}){if(this.configManager=new e(n),this.uiManager=new d(this.configManager.get()),this.urlBuilder=new r(this.configManager.get()),this.tokenValidator=new i(this.configManager.get(),this.urlBuilder),this.backendClient=new l(this.configManager.get()),this.popupManager=new u,!t.checkBrowserCompatibility())throw new Error("Browser not supported. Please use a modern browser.");this.initialize(),this.setupMessageListener()}initialize(){this.uiManager.initialize(),this.setupEventHandlers()}setupEventHandlers(){this.uiManager.setOnEnvironmentChange(e=>{this.configManager.updateConfig({environment:e}),this.urlBuilder=new r(this.configManager.get()),this.tokenValidator=new i(this.configManager.get(),this.urlBuilder),this.backendClient=new l(this.configManager.get())}),this.uiManager.setOnLogin(()=>{this.startAuthFlow()})}setupMessageListener(){window.addEventListener("message",e=>{this.isValidMessageOrigin(e.origin)?e.data&&"bjpass-auth-response"===e.data.type&&this.backendClient.handleBackendAuthResponse(e.data):console.warn("Message from unauthorized origin:",e.origin)})}isValidMessageOrigin(e){const t=this.configManager.get();return[t.backendOrigin,t.frontendOrigin].some(t=>"*"===t||t===e)}async startAuthFlow(){try{this.uiManager.setState({isLoading:!0,error:null}),this.config.useBackend?await this.backendClient.startBackendAuthFlow():await this.startDirectAuthFlow()}catch(e){this.handleError("auth_flow_error",e.message)}}async startDirectAuthFlow(){const e=this.configManager.get(),t=n.generateAndStoreAuthData(e.scope),r=await this.urlBuilder.buildAuthorizationUrl(t);this.popupManager.open(r,()=>{this.uiManager.setState({isLoading:!1}),n.getItem("success")||this.handleError("popup_closed","La fenêtre d'authentification a été fermée")})}async handlePopupResponse(e){try{const t=new URLSearchParams(e),r=t.get("code"),i=t.get("state"),s=t.get("error");if(s)return void this.handleError(s,t.get("error_description"));if(!r||!i)return void this.handleError("invalid_response","Code ou state manquant");if(i!==n.getItem("state"))return void this.handleError("invalid_state","Paramètre state invalide");n.setItem("success","true"),this.popupManager.close(),await this.exchangeCodeForTokens(r,i)}catch(e){this.handleError("callback_error",e.message)}}async exchangeCodeForTokens(e,t){try{const r=this.configManager.get();let i;if(!r.beUrl)return void this.handleError("unsuported_grant_type_error","Type de subvention OAuth non encore pris en charge.");i=await this.backendClient.exchangeCode(e,t),await this.validateTokens(i.data),n.clear(),this.uiManager.setState({isLoading:!1,error:null}),r.onSuccess&&r.onSuccess(i)}catch(e){this.handleError("token_exchange_error",e.message)}}async validateTokens(e){const t=this.configManager.get();e.id_token&&t.scope.includes("openid")&&await this.tokenValidator.validateIdToken(e.id_token),t.verifyAccessToken&&e.access_token&&await this.tokenValidator.verifyAccessToken(e.access_token)}handleError(e,t){console.error("Auth error:",e,t);const n=g.getErrorMessage(e,t);this.uiManager.setState({isLoading:!1,error:n});const r=this.configManager.get();r.onError&&r.onError({error:e,error_description:t})}async getUserInfo(){if(this.configManager.get().useBackend)try{return await this.backendClient.getUserInfoFromBackend()}catch(e){console.warn("Failed to get user info from backend, falling back to session:",e)}const e=n.getItem("user");return e?JSON.parse(e):null}async logout(){const e=this.configManager.get();if(e.useBackend)try{await this.backendClient.logoutFromBackend()}catch(e){console.warn("Backend logout failed:",e)}n.clear(),this.uiManager.setState({isLoading:!1,error:null}),e.onLogout&&e.onLogout()}async refreshToken(){const e=this.configManager.get();if(!e.useBackend)throw new Error("Token refresh not supported in direct mode");try{const t=new URL(e.backendEndpoints.refresh,e.backendUrl),n=await fetch(t.toString(),{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!n.ok)throw new Error(`Token refresh failed: ${n.status}`);const r=await n.json();return console.log("Token refreshed successfully"),r.token_info}catch(e){throw console.error("Token refresh failed:",e),e}}destroy(){this.popupManager.close(),this.uiManager.destroy(),n.clear()}refresh(){this.uiManager.destroy(),this.initialize()}getConfig(){return this.configManager.get()}updateConfig(e){this.configManager.updateConfig(e),this.urlBuilder=new r(this.configManager.get()),this.tokenValidator=new i(this.configManager.get(),this.urlBuilder),this.backendClient=new l(this.configManager.get())}}"undefined"!=typeof window&&(window.BjPassAuthWidget=p,window.BjPassComponents={ConfigManager:e,CryptoUtils:t,SessionManager:n,UIManager:d,TokenValidator:i,BackendClient:l,PopupManager:u,ErrorHandler:g}),document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("[data-bjpass-widget]").forEach(e=>{try{const t=e.dataset.bjpassWidget?JSON.parse(e.dataset.bjpassWidget):{};t.ui={...t.ui,container:`#${e.id}`},new p(t)}catch(e){console.error("Failed to initialize BjPass widget:",e)}})});class f{static create(e={}){return new p(e)}static createMultiple(e){return e.map(e=>new p(e))}static createWithTheme(e,t={}){const n={default:{primaryColor:"#0066cc",backgroundColor:"#ffffff",borderColor:"#ddd"},dark:{primaryColor:"#4da6ff",backgroundColor:"#2d2d2d",borderColor:"#555",textColor:"#ffffff"},modern:{primaryColor:"#6366f1",backgroundColor:"#fafafa",borderColor:"#e5e7eb"},minimal:{primaryColor:"#000000",backgroundColor:"#ffffff",borderColor:"transparent"}},r=n[e]||n.default;return new p({...t,ui:{...t.ui,theme:e,...r}})}}class m{constructor(e){this.widget=e,this.plugins=new Map,this.hooks=new Map}register(e,t){"function"==typeof t.init&&(this.plugins.set(e,t),t.init(this.widget))}unregister(e){const t=this.plugins.get(e);t&&"function"==typeof t.destroy&&t.destroy(),this.plugins.delete(e)}addHook(e,t){this.hooks.has(e)||this.hooks.set(e,[]),this.hooks.get(e).push(t)}executeHook(e,...t){(this.hooks.get(e)||[]).forEach(n=>{try{n(...t)}catch(t){console.error(`Hook ${e} error:`,t)}})}getPlugin(e){return this.plugins.get(e)}listPlugins(){return Array.from(this.plugins.keys())}}class w{init(e){this.widget=e,this.setupAnalytics()}setupAnalytics(){const e=this.widget.startAuthFlow.bind(this.widget),t=this.widget.exchangeCodeForTokens.bind(this.widget);this.widget.startAuthFlow=async()=>(this.track("auth_started"),e()),this.widget.exchangeCodeForTokens=async(e,n)=>{try{const r=await t(e,n);return this.track("auth_success"),r}catch(e){throw this.track("auth_error",{error:e.message}),e}}}track(e,t={}){console.log("Analytics:",e,t),void 0!==window.analytics&&window.analytics.track(e,t)}destroy(){}}class y{init(e){this.widget=e,this.originalConsoleLog=console.log,this.setupDebugMode()}setupDebugMode(){this.widget.getConfig().debug&&(this.addDebugPanel(),this.interceptMethods())}addDebugPanel(){const e=document.createElement("div");e.id="bjpass-debug-panel",e.style.cssText="\n      position: fixed;\n      top: 10px;\n      right: 10px;\n      width: 300px;\n      max-height: 400px;\n      background: rgba(0,0,0,0.9);\n      color: #00ff00;\n      font-family: monospace;\n      font-size: 12px;\n      padding: 10px;\n      border-radius: 5px;\n      overflow-y: auto;\n      z-index: 10000;\n      display: none;\n    ";const t=document.createElement("div");t.innerHTML='\n      <strong>BjPass Debug Panel</strong>\n      <button onclick="this.parentElement.parentElement.style.display=\'none\'" \n              style="float:right;background:none;border:none;color:#fff;cursor:pointer;">×</button>\n    ';const n=document.createElement("div");n.id="bjpass-debug-logs",e.appendChild(t),e.appendChild(n),document.body.appendChild(e);const r=document.createElement("button");r.textContent="🐛",r.style.cssText="\n      position: fixed;\n      top: 10px;\n      right: 10px;\n      z-index: 10001;\n      background: #000;\n      color: #0f0;\n      border: none;\n      padding: 5px 10px;\n      border-radius: 3px;\n      cursor: pointer;\n    ",r.onclick=()=>{e.style.display="none"===e.style.display?"block":"none"},document.body.appendChild(r),this.debugPanel=e,this.debugLogs=n}interceptMethods(){["startAuthFlow","handlePopupResponse","exchangeCodeForTokens","handleError"].forEach(e=>{const t=this.widget[e].bind(this.widget);this.widget[e]=(...n)=>{this.log(`${e} called with:`,n);const r=t(...n);return r instanceof Promise?r.then(t=>(this.log(`${e} resolved:`,t),t)).catch(t=>{throw this.log(`${e} rejected:`,t),t}):(this.log(`${e} returned:`,r),r)}})}log(e,t){const n=(new Date).toLocaleTimeString(),r=document.createElement("div");r.style.marginBottom="5px",r.innerHTML=`\n      <span style="color:#888">[${n}]</span> \n      ${e} \n      ${t?`<pre style="margin:5px 0;color:#ff0;">${JSON.stringify(t,null,2)}</pre>`:""}\n    `,this.debugLogs&&(this.debugLogs.appendChild(r),this.debugLogs.scrollTop=this.debugLogs.scrollHeight),console.log(`[BjPass Debug] ${e}`,t)}destroy(){this.debugPanel&&document.body.removeChild(this.debugPanel)}}class k{init(e){this.widget=e,this.maxRetries=e.getConfig().maxRetries||3,this.retryDelay=e.getConfig().retryDelay||1e3,this.setupRetryLogic()}setupRetryLogic(){const e=this.widget.exchangeCodeForTokens.bind(this.widget);this.widget.exchangeCodeForTokens=async(t,n,r=1)=>{try{return await e(t,n)}catch(e){if(r<this.maxRetries&&this.shouldRetry(e))return console.log(`Retry attempt ${r}/${this.maxRetries} after ${this.retryDelay}ms`),await this.delay(this.retryDelay*r),this.widget.exchangeCodeForTokens(t,n,r+1);throw e}}}shouldRetry(e){return["network","timeout","server_error","503","502","500"].some(t=>e.message.toLowerCase().includes(t)||e.code===t)}delay(e){return new Promise(t=>setTimeout(t,e))}destroy(){}}class b extends p{constructor(e={}){super(e),this.pluginManager=new m(this),this.setupBuiltinPlugins()}setupBuiltinPlugins(){const e=this.getConfig();e.analytics&&this.pluginManager.register("analytics",new w),e.debug&&this.pluginManager.register("debug",new y),e.maxRetries>0&&this.pluginManager.register("retry",new k)}use(e,t){return this.pluginManager.register(e,t),this}unuse(e){return this.pluginManager.unregister(e),this}getPlugin(e){return this.pluginManager.getPlugin(e)}addHook(e,t){return this.pluginManager.addHook(e,t),this}executeHook(e,...t){this.pluginManager.executeHook(e,...t)}async startAuthFlow(){this.executeHook("beforeAuthStart");try{const e=await super.startAuthFlow();return this.executeHook("afterAuthStart",e),e}catch(e){throw this.executeHook("authStartError",e),e}}async exchangeCodeForTokens(e,t){this.executeHook("beforeTokenExchange",e,t);try{const n=await super.exchangeCodeForTokens(e,t);return this.executeHook("afterTokenExchange",n),n}catch(e){throw this.executeHook("tokenExchangeError",e),e}}destroy(){this.executeHook("beforeDestroy"),this.pluginManager.listPlugins().forEach(e=>{this.pluginManager.unregister(e)}),super.destroy(),this.executeHook("afterDestroy")}}"undefined"!=typeof window&&(window.BjPassAuthWidget=p,window.EnhancedBjPassAuthWidget=b,window.BjPassWidgetFactory=f,window.BjPassComponents={ConfigManager:e,CryptoUtils:t,SessionManager:n,UIManager:d,TokenValidator:i,BackendClient:l,PopupManager:u,ErrorHandler:g,PluginManager:m},window.BjPassPlugins={AnalyticsPlugin:w,DebugPlugin:y,RetryPlugin:k},window.createBjPassWidget=e=>f.create(e)),"undefined"!=typeof module&&module.exports?module.exports=p:"function"==typeof define&&define.amd?define(()=>p):"undefined"!=typeof exports&&(exports.BjPassAuthWidget=p),module.exports=p;
