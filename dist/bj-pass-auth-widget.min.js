!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("BjPassAuthWidget",[],e):"object"==typeof exports?exports.BjPassAuthWidget=e():t.BjPassAuthWidget=e()}(this,function(){return t={204:function(t,e,n){var i;class o{constructor(t={}){this.config=this.mergeConfig(t),this.state={isAuthenticated:!1,tokens:null,authWindow:null,codeVerifier:null,codeChallenge:null},this.init()}mergeConfig(t){const e={clientId:"",environment:"test",authServer:"main-as",scope:"openid profile",redirectUri:window.location.origin+"/auth/callback",pkce:!0,verifyAccessToken:!1,beUrl:"",beBearer:"",ui:{showEnvSelector:!0,container:"#bj-pass-auth-container",language:"fr",primaryColor:"#0066cc",theme:"default"},onSuccess:null,onError:null,debug:!1,analytics:!1,maxRetries:0,retryDelay:1e3};return this.deepMerge(e,t)}deepMerge(t,e){const n={...t};for(const t in e)e[t]&&"object"==typeof e[t]&&!Array.isArray(e[t])?n[t]=this.deepMerge(n[t]||{},e[t]):n[t]=e[t];return n}init(){this.log("Initialisation du widget bj-pass...",this.config),this.config.clientId?(this.config.pkce&&this.generatePKCE(),this.createUI(),this.log("Widget initialisé avec succès")):this.handleError(new Error("clientId est requis"))}generatePKCE(){const t=new Uint8Array(32);crypto.getRandomValues(t),this.state.codeVerifier=this.base64URLEncode(t);const e=(new TextEncoder).encode(this.state.codeVerifier);crypto.subtle.digest("SHA-256",e).then(t=>{this.state.codeChallenge=this.base64URLEncode(new Uint8Array(t))})}base64URLEncode(t){return btoa(String.fromCharCode(...t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}createUI(){document.querySelector(this.config.ui.container)||(this.log("Container non trouvé, création automatique..."),this.createContainer()),this.renderAuthButton()}createContainer(){const t=document.createElement("div");t.id="bj-pass-auth-container",t.style.cssText="\n      display: inline-block;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    ",document.body.appendChild(t)}renderAuthButton(){const t=document.querySelector(this.config.ui.container);if(!t)return;const e=document.createElement("button");e.id="bj-pass-auth-button",e.textContent="fr"===this.config.ui.language?"Se connecter":"Sign in",e.style.cssText=`\n      background-color: ${this.config.ui.primaryColor};\n      color: white;\n      border: none;\n      padding: 12px 24px;\n      border-radius: 6px;\n      font-size: 16px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: background-color 0.2s;\n    `,e.addEventListener("click",()=>this.startAuthFlow()),e.addEventListener("mouseenter",()=>{e.style.backgroundColor=this.adjustColor(this.config.ui.primaryColor,-20)}),e.addEventListener("mouseleave",()=>{e.style.backgroundColor=this.config.ui.primaryColor}),t.innerHTML="",t.appendChild(e)}adjustColor(t,e){const n=t.replace("#",""),i=parseInt(n,16);return`#${(Math.min(255,Math.max(0,(i>>16)+e))<<16|Math.min(255,Math.max(0,(i>>8&255)+e))<<8|Math.min(255,Math.max(0,(255&i)+e))).toString(16).padStart(6,"0")}`}startAuthFlow(){this.log("Démarrage du flux d'authentification...");try{const t=this.buildAuthUrl();this.openAuthWindow(t)}catch(t){this.handleError(t)}}buildAuthUrl(){const t=this.getAuthServerUrl(),e=new URLSearchParams({response_type:"code",client_id:this.config.clientId,redirect_uri:this.config.redirectUri,scope:this.config.scope,state:this.generateState()});return this.config.pkce&&this.state.codeChallenge&&(e.append("code_challenge",this.state.codeChallenge),e.append("code_challenge_method","S256")),`${t}/oauth2/authorize?${e.toString()}`}getAuthServerUrl(){const t={"main-as":"https://auth.bj-pass.com","test-as":"https://test-auth.bj-pass.com"};return t[this.config.authServer]||t["main-as"]}generateState(){const t=new Uint8Array(16);return crypto.getRandomValues(t),this.base64URLEncode(t)}openAuthWindow(t){const e=(window.screen.width-500)/2,n=(window.screen.height-600)/2;if(this.state.authWindow=window.open(t,"bj-pass-auth",`width=500,height=600,left=${e},top=${n},scrollbars=yes,resizable=yes`),!this.state.authWindow)return void this.handleError(new Error("Popup bloquée. Veuillez autoriser les popups pour ce site."));const i=setInterval(()=>{this.state.authWindow.closed&&(clearInterval(i),this.log("Fenêtre d'authentification fermée"))},1e3)}handleCallback(t,e){this.log("Callback reçu, échange du code..."),this.config.beUrl?this.exchangeCodeWithBackend(t):this.exchangeCodeDirectly(t)}async exchangeCodeWithBackend(t){try{const e=await fetch(this.config.beUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:this.config.beBearer},body:JSON.stringify({code:t,code_verifier:this.state.codeVerifier,redirect_uri:this.config.redirectUri})});if(!e.ok)throw new Error(`Erreur backend: ${e.status}`);const n=await e.json();this.handleSuccess(n)}catch(t){this.handleError(t)}}async exchangeCodeDirectly(t){try{const e=this.getAuthServerUrl()+"/oauth2/token",n=new URLSearchParams({grant_type:"authorization_code",client_id:this.config.clientId,code:t,redirect_uri:this.config.redirectUri});this.state.codeVerifier&&n.append("code_verifier",this.state.codeVerifier);const i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n});if(!i.ok)throw new Error(`Erreur token: ${i.status}`);const o=await i.json();this.handleSuccess(o)}catch(t){this.handleError(t)}}handleSuccess(t){this.log("Authentification réussie !",t),this.state.isAuthenticated=!0,this.state.tokens=t,this.state.authWindow&&this.state.authWindow.close(),"function"==typeof this.config.onSuccess&&this.config.onSuccess(t),this.updateUI()}handleError(t){this.log("Erreur:",t),this.state.authWindow&&this.state.authWindow.close(),"function"==typeof this.config.onError&&this.config.onError(t)}updateUI(){const t=document.querySelector("#bj-pass-auth-button");t&&(t.textContent="fr"===this.config.ui.language?"Connecté ✓":"Connected ✓",t.style.backgroundColor="#28a745",t.disabled=!0)}log(...t){this.config.debug}destroy(){this.log("Destruction du widget..."),this.state.authWindow&&this.state.authWindow.close();const t=document.querySelector(this.config.ui.container);t&&(t.innerHTML=""),this.state={isAuthenticated:!1,tokens:null,authWindow:null,codeVerifier:null,codeChallenge:null}}getConfig(){return{...this.config}}updateConfig(t){this.config=this.mergeConfig(t),this.log("Configuration mise à jour:",this.config)}isAuthenticated(){return this.state.isAuthenticated}getTokens(){return this.state.tokens}}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("[data-bj-pass-widget]").forEach(t=>{const e=JSON.parse(t.getAttribute("data-bj-pass-config")||"{}");e.ui=e.ui||{},e.ui.container="#"+t.id,new o(e)})}),t.exports?t.exports=o:void 0===(i=(()=>o).call(e,n,e,t))||(t.exports=i)}},e={},function n(i){var o=e[i];if(void 0!==o)return o.exports;var r=e[i]={exports:{}};return t[i](r,r.exports,n),r.exports}(204).default;var t,e});
//# sourceMappingURL=bj-pass-auth-widget.min.js.map